<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Strategy Builder</title>

    <!-- Blockly.js from CDN -->
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <script src="https://unpkg.com/blockly/python_compressed.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--vscode-font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif);
            background: var(--vscode-editor-background, #1e1e1e);
            color: var(--vscode-foreground, #cccccc);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            padding: 12px 16px;
            background: var(--vscode-sideBar-background, #252526);
            border-bottom: 1px solid var(--vscode-panel-border, #3e3e42);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 14px;
            font-weight: 600;
            color: var(--vscode-foreground, #cccccc);
        }

        .header-controls {
            display: flex;
            gap: 8px;
        }

        .btn {
            background: var(--vscode-button-background, #0e639c);
            color: var(--vscode-button-foreground, #ffffff);
            border: none;
            padding: 6px 14px;
            border-radius: 2px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .btn:hover {
            background: var(--vscode-button-hoverBackground, #1177bb);
        }

        .btn-secondary {
            background: var(--vscode-button-secondaryBackground, #3a3d41);
            color: var(--vscode-button-secondaryForeground, #cccccc);
        }

        .btn-secondary:hover {
            background: var(--vscode-button-secondaryHoverBackground, #45494e);
        }

        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .workspace-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--vscode-panel-border, #3e3e42);
        }

        #blocklyDiv {
            flex: 1;
            width: 100%;
        }

        .code-panel {
            width: 400px;
            display: flex;
            flex-direction: column;
            background: var(--vscode-sideBar-background, #252526);
        }

        .panel-header {
            padding: 8px 12px;
            background: var(--vscode-sideBarSectionHeader-background, #2d2d30);
            border-bottom: 1px solid var(--vscode-panel-border, #3e3e42);
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--vscode-sideBarSectionHeader-foreground, #cccccc);
        }

        .code-preview {
            flex: 1;
            overflow: auto;
            padding: 12px;
        }

        .code-preview pre {
            background: var(--vscode-editor-background, #1e1e1e);
            padding: 12px;
            border-radius: 4px;
            border: 1px solid var(--vscode-panel-border, #3e3e42);
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
            color: var(--vscode-editor-foreground, #d4d4d4);
        }

        .backtest-config {
            padding: 12px;
            border-top: 1px solid var(--vscode-panel-border, #3e3e42);
        }

        .config-group {
            margin-bottom: 12px;
        }

        .config-group label {
            display: block;
            font-size: 12px;
            margin-bottom: 4px;
            color: var(--vscode-descriptionForeground, #9d9d9d);
        }

        .config-group input {
            width: 100%;
            background: var(--vscode-input-background, #3c3c3c);
            color: var(--vscode-input-foreground, #cccccc);
            border: 1px solid var(--vscode-input-border, #3e3e42);
            padding: 6px 8px;
            border-radius: 2px;
            font-size: 13px;
            font-family: inherit;
        }

        .config-group input:focus {
            outline: none;
            border-color: var(--vscode-focusBorder, #007acc);
        }

        .results-panel {
            display: none;
            padding: 16px;
            background: var(--vscode-editor-background, #1e1e1e);
            border-top: 1px solid var(--vscode-panel-border, #3e3e42);
            max-height: 300px;
            overflow-y: auto;
        }

        .results-panel.visible {
            display: block;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 16px;
        }

        .metric-card {
            background: var(--vscode-sideBar-background, #252526);
            padding: 12px;
            border-radius: 4px;
            border: 1px solid var(--vscode-panel-border, #3e3e42);
        }

        .metric-label {
            font-size: 11px;
            color: var(--vscode-descriptionForeground, #9d9d9d);
            margin-bottom: 4px;
        }

        .metric-value {
            font-size: 20px;
            font-weight: 600;
        }

        .metric-value.positive {
            color: #26a69a;
        }

        .metric-value.negative {
            color: #ef5350;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--vscode-descriptionForeground, #9d9d9d);
        }

        .error {
            background: rgba(239, 83, 80, 0.1);
            border: 1px solid #ef5350;
            color: #ef5350;
            padding: 12px;
            border-radius: 4px;
            margin-top: 12px;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>ðŸ“Š Visual Strategy Builder</h1>
        <div class="header-controls">
            <button class="btn btn-secondary" id="clearBtn">Clear</button>
            <button class="btn btn-secondary" id="exampleBtn">Load Example</button>
            <button class="btn" id="runBacktestBtn">Run Backtest</button>
        </div>
    </div>

    <div class="main-container">
        <div class="workspace-panel">
            <div id="blocklyDiv"></div>
        </div>

        <div class="code-panel">
            <div class="panel-header">Generated Python Code</div>
            <div class="code-preview">
                <pre id="codePreview"># Drag blocks to generate code...</pre>
            </div>

            <div class="panel-header">Backtest Configuration</div>
            <div class="backtest-config">
                <div class="config-group">
                    <label>Ticker Symbol</label>
                    <input type="text" id="tickerInput" placeholder="AAPL" value="AAPL" />
                </div>
                <div class="config-group">
                    <label>Start Date</label>
                    <input type="date" id="startDate" value="2020-01-01" />
                </div>
                <div class="config-group">
                    <label>End Date</label>
                    <input type="date" id="endDate" value="2024-01-01" />
                </div>
            </div>
        </div>
    </div>

    <div class="results-panel" id="resultsPanel">
        <div class="panel-header">Backtest Results</div>
        <div id="resultsContent"></div>
    </div>

    <script>
        const vscode = acquireVsCodeApi();

        // Define custom blocks
        Blockly.defineBlocksWithJsonArray([
            // RSI Indicator Block
            {
                "type": "rsi_indicator",
                "message0": "RSI with period %1",
                "args0": [
                    {
                        "type": "field_number",
                        "name": "PERIOD",
                        "value": 14,
                        "min": 1,
                        "max": 100
                    }
                ],
                "output": "Number",
                "colour": 230,
                "tooltip": "Calculate RSI (Relative Strength Index)",
                "helpUrl": ""
            },
            // Comparison Block
            {
                "type": "comparison",
                "message0": "%1 %2 %3",
                "args0": [
                    {
                        "type": "input_value",
                        "name": "A"
                    },
                    {
                        "type": "field_dropdown",
                        "name": "OP",
                        "options": [
                            ["<", "LT"],
                            [">", "GT"],
                            ["==", "EQ"],
                            ["<=", "LTE"],
                            [">=", "GTE"]
                        ]
                    },
                    {
                        "type": "input_value",
                        "name": "B"
                    }
                ],
                "output": "Boolean",
                "colour": 210,
                "tooltip": "Compare two values",
                "helpUrl": ""
            },
            // Number Block
            {
                "type": "number_input",
                "message0": "%1",
                "args0": [
                    {
                        "type": "field_number",
                        "name": "NUM",
                        "value": 30
                    }
                ],
                "output": "Number",
                "colour": 290,
                "tooltip": "A number value",
                "helpUrl": ""
            },
            // Buy Action Block
            {
                "type": "buy_action",
                "message0": "Buy when %1",
                "args0": [
                    {
                        "type": "input_value",
                        "name": "CONDITION",
                        "check": "Boolean"
                    }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 120,
                "tooltip": "Buy when condition is true",
                "helpUrl": ""
            },
            // Sell Action Block
            {
                "type": "sell_action",
                "message0": "Sell when %1",
                "args0": [
                    {
                        "type": "input_value",
                        "name": "CONDITION",
                        "check": "Boolean"
                    }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 0,
                "tooltip": "Sell when condition is true",
                "helpUrl": ""
            }
        ]);

        // Python code generators - must be defined using pythonGenerator object
        const pythonGenerator = Blockly.Python;

        pythonGenerator.forBlock['rsi_indicator'] = function (block, generator) {
            const period = block.getFieldValue('PERIOD');
            return ['self.rsi', pythonGenerator.ORDER_ATOMIC];
        };

        pythonGenerator.forBlock['comparison'] = function (block, generator) {
            const OPERATORS = {
                'LT': '<',
                'GT': '>',
                'EQ': '==',
                'LTE': '<=',
                'GTE': '>='
            };
            const operator = OPERATORS[block.getFieldValue('OP')];
            const argument0 = generator.valueToCode(block, 'A', pythonGenerator.ORDER_RELATIONAL) || '0';
            const argument1 = generator.valueToCode(block, 'B', pythonGenerator.ORDER_RELATIONAL) || '0';
            const code = argument0 + ' ' + operator + ' ' + argument1;
            return [code, pythonGenerator.ORDER_RELATIONAL];
        };

        pythonGenerator.forBlock['number_input'] = function (block, generator) {
            const number = block.getFieldValue('NUM');
            return [number, pythonGenerator.ORDER_ATOMIC];
        };

        pythonGenerator.forBlock['buy_action'] = function (block, generator) {
            const condition = generator.valueToCode(block, 'CONDITION', pythonGenerator.ORDER_NONE) || 'False';
            return `if ${condition}:\n    if not self.position:\n        self.buy()\n`;
        };

        pythonGenerator.forBlock['sell_action'] = function (block, generator) {
            const condition = generator.valueToCode(block, 'CONDITION', pythonGenerator.ORDER_NONE) || 'False';
            return `if ${condition}:\n    if self.position:\n        self.position.close()\n`;
        };

        // Initialize Blockly workspace
        const workspace = Blockly.inject('blocklyDiv', {
            toolbox: {
                "kind": "categoryToolbox",
                "contents": [
                    {
                        "kind": "category",
                        "name": "Indicators",
                        "colour": "230",
                        "contents": [
                            {
                                "kind": "block",
                                "type": "rsi_indicator"
                            }
                        ]
                    },
                    {
                        "kind": "category",
                        "name": "Logic",
                        "colour": "210",
                        "contents": [
                            {
                                "kind": "block",
                                "type": "comparison"
                            }
                        ]
                    },
                    {
                        "kind": "category",
                        "name": "Values",
                        "colour": "290",
                        "contents": [
                            {
                                "kind": "block",
                                "type": "number_input"
                            }
                        ]
                    },
                    {
                        "kind": "category",
                        "name": "Actions",
                        "colour": "120",
                        "contents": [
                            {
                                "kind": "block",
                                "type": "buy_action"
                            },
                            {
                                "kind": "block",
                                "type": "sell_action"
                            }
                        ]
                    }
                ]
            },
            grid: {
                spacing: 20,
                length: 3,
                colour: '#3e3e42',
                snap: true
            },
            zoom: {
                controls: true,
                wheel: true,
                startScale: 1.0,
                maxScale: 3,
                minScale: 0.3,
                scaleSpeed: 1.2
            },
            trashcan: true
        });

        // Update code preview when workspace changes
        function updateCodePreview() {
            try {
                Blockly.Python.INFINITE_LOOP_TRAP = null;
                const blockCode = Blockly.Python.workspaceToCode(workspace);

                if (!blockCode.trim()) {
                    document.getElementById('codePreview').textContent = '# Drag blocks to generate code...';
                    return;
                }

                // Get RSI period from blocks
                let rsiPeriod = 14;
                const blocks = workspace.getAllBlocks();
                blocks.forEach(block => {
                    if (block.type === 'rsi_indicator') {
                        rsiPeriod = block.getFieldValue('PERIOD');
                    }
                });

                // Generate complete Python code
                const fullCode = `from backtesting import Strategy, Backtest
import talib

class RSIStrategy(Strategy):
    rsi_period = ${rsiPeriod}
    
    def init(self):
        self.rsi = self.I(talib.RSI, self.data.Close, self.rsi_period)
    
    def next(self):
        ${blockCode.trim().split('\n').join('\n        ')}`;

                document.getElementById('codePreview').textContent = fullCode;
            } catch (e) {
                console.error('Code generation error:', e);
            }
        }

        workspace.addChangeListener(updateCodePreview);

        // Load example strategy
        document.getElementById('exampleBtn').addEventListener('click', () => {
            workspace.clear();

            const xmlText = `
                <xml xmlns="https://developers.google.com/blockly/xml">
                    <block type="buy_action" x="100" y="100">
                        <value name="CONDITION">
                            <block type="comparison">
                                <field name="OP">LT</field>
                                <value name="A">
                                    <block type="rsi_indicator">
                                        <field name="PERIOD">14</field>
                                    </block>
                                </value>
                                <value name="B">
                                    <block type="number_input">
                                        <field name="NUM">30</field>
                                    </block>
                                </value>
                            </block>
                        </value>
                        <next>
                            <block type="sell_action">
                                <value name="CONDITION">
                                    <block type="comparison">
                                        <field name="OP">GT</field>
                                        <value name="A">
                                            <block type="rsi_indicator">
                                                <field name="PERIOD">14</field>
                                            </block>
                                        </value>
                                        <value name="B">
                                            <block type="number_input">
                                                <field name="NUM">70</field>
                                            </block>
                                        </value>
                                    </block>
                                </value>
                            </block>
                        </next>
                    </block>
                </xml>
            `;
            const xml = Blockly.utils.xml.textToDom(xmlText);
            Blockly.Xml.domToWorkspace(xml, workspace);
        });

        // Clear workspace
        document.getElementById('clearBtn').addEventListener('click', () => {
            // Sandboxed webview doesn't allow confirm(), so just clear directly
            workspace.clear();
        });

        // Run backtest
        document.getElementById('runBacktestBtn').addEventListener('click', () => {
            const code = document.getElementById('codePreview').textContent;

            if (code.includes('# Drag blocks')) {
                displayError('Please create a strategy first!');
                return;
            }

            const config = {
                ticker: document.getElementById('tickerInput').value.toUpperCase(),
                start: document.getElementById('startDate').value,
                end: document.getElementById('endDate').value,
                strategy_code: code
            };

            // Show loading
            const resultsPanel = document.getElementById('resultsPanel');
            const resultsContent = document.getElementById('resultsContent');
            resultsPanel.classList.add('visible');
            resultsContent.innerHTML = '<div class="loading">Running backtest...</div>';

            // Send to extension
            vscode.postMessage({
                command: 'runBacktest',
                config: config
            });
        });

        // Handle messages from extension
        window.addEventListener('message', event => {
            const message = event.data;

            switch (message.type) {
                case 'backtestResults':
                    displayResults(message.results);
                    break;
                case 'backtestError':
                    displayError(message.error);
                    break;
            }
        });

        function displayResults(results) {
            const resultsContent = document.getElementById('resultsContent');

            const html = `
                <div class="results-grid">
                    <div class="metric-card">
                        <div class="metric-label">Total Return</div>
                        <div class="metric-value ${results.return >= 0 ? 'positive' : 'negative'}">
                            ${results.return >= 0 ? '+' : ''}${results.return.toFixed(2)}%
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Sharpe Ratio</div>
                        <div class="metric-value">
                            ${results.sharpe.toFixed(2)}
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Max Drawdown</div>
                        <div class="metric-value negative">
                            ${results.max_drawdown.toFixed(2)}%
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Total Trades</div>
                        <div class="metric-value">
                            ${results.num_trades}
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Win Rate</div>
                        <div class="metric-value">
                            ${results.win_rate.toFixed(1)}%
                        </div>
                    </div>
                </div>
            `;

            resultsContent.innerHTML = html;
        }

        function displayError(error) {
            const resultsPanel = document.getElementById('resultsPanel');
            const resultsContent = document.getElementById('resultsContent');
            resultsPanel.classList.add('visible');
            resultsContent.innerHTML = `<div class="error"><strong>Error:</strong> ${error}</div>`;
        }

        // Initialize with example on first load
        setTimeout(() => {
            document.getElementById('exampleBtn').click();
        }, 500);
    </script>
</body>

</html>