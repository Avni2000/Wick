<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Strategy Builder</title>

    <!-- Drawflow CSS & JS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow/dist/drawflow.min.css">
    <script src="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow/dist/drawflow.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css">

    <style>
        :root {
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --bg-tertiary: #252526;
            --border-color: #333333;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --accent-color: #007fd4;
            --accent-hover: #0060a0;
            --danger-color: #f48771;
            --success-color: #89d185;
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        .header {
            height: 50px;
            padding: 0 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .header h1 {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-controls {
            display: flex;
            gap: 10px;
        }

        /* Buttons */
        .btn {
            background: var(--accent-color);
            color: #ffffff;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-tertiary);
            border-color: #555;
        }

        /* Main Layout */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .workspace-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            background: var(--bg-primary);
            background-size: 20px 20px;
            background-image: radial-gradient(#333 1px, transparent 1px);
        }

        #drawflow {
            width: 100%;
            height: 100%;
            text-align: initial;
            background: transparent;
        }

        /* Sidebar / Code Panel */
        .sidebar {
            width: 250px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            z-index: 5;
        }

        .code-panel {
            width: 350px;
            display: flex;
            flex-direction: column;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            z-index: 5;
        }

        .panel-header {
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            border-top: 1px solid var(--border-color);
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }

        .panel-header:first-child {
            border-top: none;
        }

        /* Draggable Items */
        .drag-items {
            padding: 10px;
            overflow-y: auto;
            flex: 1;
        }

        .drag-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: grab;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
        }

        .drag-item:hover {
            border-color: var(--accent-color);
            transform: translateY(-1px);
        }

        .drag-item i {
            width: 20px;
            text-align: center;
        }

        /* Drawflow Node Styles */
        .drawflow .drawflow-node {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            width: 200px;
            padding: 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .drawflow .drawflow-node.selected {
            background: var(--bg-secondary);
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(0, 127, 212, 0.3);
        }

        .drawflow .drawflow-node .input,
        .drawflow .drawflow-node .output {
            width: 10px;
            height: 10px;
            background: var(--text-secondary);
            border-radius: 50%;
            border: 1px solid var(--bg-primary);
        }

        .drawflow .drawflow-node .input:hover,
        .drawflow .drawflow-node .output:hover {
            background: var(--accent-color);
        }

        .node-header {
            padding: 8px 12px;
            border-radius: 6px 6px 0 0;
            font-size: 12px;
            font-weight: 600;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .node-body {
            padding: 12px;
        }

        .node-body input,
        .node-body select {
            width: 100%;
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 6px;
            border-radius: 4px;
            font-size: 12px;
            margin-top: 4px;
        }

        /* Hide up/down arrows in number inputs */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        /* Node Colors */
        .header-indicator {
            background: #7E57C2;
        }

        .header-logic {
            background: #42A5F5;
        }

        .header-value {
            background: #26A69A;
        }

        .header-action {
            background: #FFA726;
            color: #1e1e1e !important;
        }

        .header-logic {
            background: #EF5350;
        }

        .header-price {
            background: #66BB6A;
        }

        /* Compact inputs in nodes */
        .node-row {
            display: flex;
            gap: 4px;
            margin-top: 4px;
            align-items: center;
        }

        .node-row label {
            font-size: 10px;
            color: #aaa;
            min-width: 30px;
        }

        .node-row select,
        .node-row input {
            margin-top: 0;
            padding: 4px;
        }

        /* Code Preview */
        .code-preview {
            flex: 1;
            overflow: auto;
            padding: 0;
            background: var(--bg-primary);
        }

        .code-preview pre {
            margin: 0;
            padding: 16px;
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 12px;
            line-height: 1.6;
            color: #d4d4d4;
            background: transparent;
            border: none;
        }

        /* Results Panel */
        .results-panel {
            display: none;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            max-height: 300px;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }

        .results-panel.visible {
            display: block;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1px;
            background: var(--border-color);
            padding: 1px;
        }

        .metric-card {
            background: var(--bg-secondary);
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .metric-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 300;
            color: var(--text-primary);
        }

        .metric-value.positive {
            color: var(--success-color);
        }

        .metric-value.negative {
            color: var(--danger-color);
        }

        /* Config Forms */
        .backtest-config {
            padding: 16px;
            background: var(--bg-secondary);
        }

        .config-group {
            margin-bottom: 12px;
        }

        .config-group label {
            display: block;
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .config-group input {
            width: 100%;
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 6px;
            border-radius: 4px;
        }

        /* Tabs */
        .tab-container {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }

        .tab-header {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding-left: 10px;
        }

        .tab-btn {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }

        .tab-btn.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }

        .tab-content {
            display: none;
            flex: 1;
            overflow: hidden;
            flex-direction: column;
        }

        .tab-content.active {
            display: flex;
        }

        /* Collapsible Sidebars */
        .sidebar,
        .code-panel {
            transition: width 0.3s ease, min-width 0.3s ease;
            position: relative;
        }

        .sidebar.collapsed {
            width: 40px !important;
            min-width: 40px !important;
            overflow: hidden;
        }

        .code-panel.collapsed {
            width: 40px !important;
            min-width: 40px !important;
            overflow: hidden;
        }

        .sidebar.collapsed .panel-header,
        .sidebar.collapsed .drag-items,
        .code-panel.collapsed .panel-header,
        .code-panel.collapsed .code-preview,
        .code-panel.collapsed .backtest-config {
            opacity: 0;
            pointer-events: none;
            display: none;
            /* Hide content when collapsed */
        }

        .collapse-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .collapse-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .sidebar.collapsed .collapse-btn,
        .code-panel.collapsed .collapse-btn {
            right: 50%;
            transform: translateX(50%);
            top: 12px;
        }

        .sidebar.collapsed .collapse-btn i,
        .code-panel.collapsed .collapse-btn i {
            transform: rotate(180deg);
        }

        /* Results Tab Specifics */
        #resultsContent {
            padding: 20px;
            overflow-y: auto;
            height: 100%;
        }

        /* Adjust Main Container for Tabs */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            flex-direction: column;
            /* Changed to column to stack tabs */
        }

        /* Workspace needs to fill flex */
        .workspace-wrapper {
            display: flex;
            flex: 1;
            overflow: hidden;
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>
            <i class="fas fa-project-diagram" style="margin-right: 8px; color: var(--accent-color);"></i>
            Strategy Flow
        </h1>
        <div class="header-controls">
            <button class="btn btn-secondary" id="clearBtn">Clear</button>
            <button class="btn btn-secondary" id="exampleBtn">Load Example</button>
            <button class="btn btn-secondary" id="saveStrategyBtn">
                <i class="fas fa-save" style="margin-right: 6px;"></i>
                Save Strategy
            </button>
            <button class="btn" id="runBacktestBtn">
                <i class="fas fa-play" style="margin-right: 6px;"></i>
                Run Backtest
            </button>
            <button class="btn" id="deployLiveBtn" style="background: #FFA726;">
                <i class="fas fa-rocket" style="margin-right: 6px;"></i>
                Deploy Live
            </button>
        </div>
    </div>

    <div class="main-container">
        <div class="tab-header">
            <button class="tab-btn active" data-tab="builder">Builder</button>
            <button class="tab-btn" data-tab="results">Results</button>
        </div>

        <!-- Builder Tab -->
        <div class="tab-content active" id="tab-builder">
            <div class="workspace-wrapper">
                <div class="sidebar" id="leftSidebar">
                    <button class="collapse-btn" onclick="toggleSidebar('leftSidebar')">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="panel-header">Logic</div>
                    <div class="drag-items">
                        <div class="drag-item" draggable="true" ondragstart="drag(event)" data-node="and">
                            <i class="fas fa-link" style="color: #EF5350;"></i> AND
                        </div>
                        <div class="drag-item" draggable="true" ondragstart="drag(event)" data-node="or">
                            <i class="fas fa-project-diagram" style="color: #EF5350;"></i> OR
                        </div>
                    </div>

                    <div class="panel-header">Indicators</div>
                    <div class="drag-items">
                        <div class="drag-item" draggable="true" ondragstart="drag(event)" data-node="price">
                            <i class="fas fa-dollar-sign" style="color: #66BB6A;"></i> Price
                        </div>
                        <div class="drag-item" draggable="true" ondragstart="drag(event)" data-node="rsi">
                            <i class="fas fa-chart-line" style="color: #7E57C2;"></i> RSI
                        </div>
                        <div class="drag-item" draggable="true" ondragstart="drag(event)" data-node="sma">
                            <i class="fas fa-wave-square" style="color: #42A5F5;"></i> SMA
                        </div>
                        <div class="drag-item" draggable="true" ondragstart="drag(event)" data-node="ema">
                            <i class="fas fa-wave-square" style="color: #26C6DA;"></i> EMA
                        </div>
                        <div class="drag-item" draggable="true" ondragstart="drag(event)" data-node="macd">
                            <i class="fas fa-chart-bar" style="color: #FF7043;"></i> MACD
                        </div>
                        <div class="drag-item" draggable="true" ondragstart="drag(event)" data-node="bb">
                            <i class="fas fa-ruler-combined" style="color: #AB47BC;"></i> Bollinger Bands
                        </div>
                    </div>

                    <div class="panel-header">Actions</div>
                    <div class="drag-items">
                        <div class="drag-item" draggable="true" ondragstart="drag(event)" data-node="action">
                            <i class="fas fa-bolt" style="color: #FFA726;"></i> Action
                        </div>
                    </div>
                </div>

                <div class="workspace-panel">
                    <div id="drawflow" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                </div>

                <div class="code-panel" id="rightSidebar">
                    <button class="collapse-btn" onclick="toggleSidebar('rightSidebar')">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    <div class="panel-header">Generated Python</div>
                    <div class="code-preview">
                        <pre id="codePreview"># Build your flow to generate code...</pre>
                    </div>

                    <div class="panel-header">Configuration</div>
                    <div class="backtest-config">
                        <div class="config-group">
                            <label>Ticker Symbol</label>
                            <input type="text" id="tickerInput" placeholder="GOOGL" value="GOOGL" />
                        </div>
                        <div class="config-group">
                            <label>Start Date</label>
                            <input type="date" id="startDate" value="2020-01-01" />
                        </div>
                        <div class="config-group">
                            <label>End Date</label>
                            <input type="date" id="endDate" value="2024-01-01" />
                        </div>
                    </div>
                    <div class="panel-header">Sync Settings</div>
                    <div class="backtest-config">
                        <button class="btn btn-secondary" id="pullFromChartBtn"
                            style="width: 100%; justify-content: center;">
                            <i class="fas fa-sync-alt" style="margin-right: 6px;"></i>
                            Pull from Chart
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Tab -->
        <div class="tab-content" id="tab-results">
            <div id="resultsContent">
                <div style="text-align: center; color: var(--text-secondary); margin-top: 50px;">
                    <i class="fas fa-chart-area" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;"></i>
                    <p>Run a backtest to see results here.</p>
                </div>
            </div>
        </div>


    </div>

    <script>
        const vscode = acquireVsCodeApi();
        var id = document.getElementById("drawflow");
        const editor = new Drawflow(id);
        editor.reroute = true;
        editor.start();

        // --- Node Templates ---

        const html_and = `
            <div class="node-header header-logic"><i class="fas fa-link"></i> AND</div>
            <div class="node-body">
                <div style="font-size:10px; color:#aaa;">All inputs must be true</div>
            </div>
        `;

        const html_or = `
            <div class="node-header header-logic"><i class="fas fa-project-diagram"></i> OR</div>
            <div class="node-body">
                <div style="font-size:10px; color:#aaa;">Any input must be true</div>
            </div>
        `;

        const html_price = `
            <div class="node-header header-price"><i class="fas fa-dollar-sign"></i> Price</div>
            <div class="node-body">
                <div class="node-row">
                    <select df-source style="width: 100%">
                        <option value="Close">Close</option>
                        <option value="Open">Open</option>
                        <option value="High">High</option>
                        <option value="Low">Low</option>
                    </select>
                </div>
                <div class="node-row">
                    <select df-op style="width: 60px">
                        <option value=">">></option>
                        <option value="<"><</option>
                        <option value=">=">>=</option>
                        <option value="<="><=</option>
                        <option value="==">==</option>
                    </select>
                    <input type="number" df-value value="100" style="width: 80px">
                </div>
            </div>
        `;

        const html_rsi = `
            <div class="node-header header-indicator"><i class="fas fa-chart-line"></i> RSI</div>
            <div class="node-body">
                <div class="node-row">
                    <label>Len</label>
                    <input type="number" df-period value="14" min="1">
                </div>
                <div class="node-row">
                    <select df-op style="width: 60px">
                        <option value=">">></option>
                        <option value="<"><</option>
                        <option value=">=">>=</option>
                        <option value="<="><=</option>
                    </select>
                    <input type="number" df-value value="30" style="width: 80px">
                </div>
            </div>
        `;

        const html_sma = `
            <div class="node-header header-indicator" style="background: #42A5F5;"><i class="fas fa-wave-square"></i> SMA</div>
            <div class="node-body">
                <div class="node-row">
                    <label>Len</label>
                    <input type="number" df-period value="20" min="1">
                </div>
                <div class="node-row">
                    <select df-op style="width: 60px">
                        <option value=">">></option>
                        <option value="<"><</option>
                    </select>
                    <input type="number" df-value value="100" style="width: 80px">
                </div>
            </div>
        `;

        const html_ema = `
            <div class="node-header header-indicator" style="background: #26C6DA;"><i class="fas fa-wave-square"></i> EMA</div>
            <div class="node-body">
                <div class="node-row">
                    <label>Len</label>
                    <input type="number" df-period value="20" min="1">
                </div>
                <div class="node-row">
                    <select df-op style="width: 60px">
                        <option value=">">></option>
                        <option value="<"><</option>
                    </select>
                    <input type="number" df-value value="100" style="width: 80px">
                </div>
            </div>
        `;

        const html_macd = `
            <div class="node-header header-indicator" style="background: #FF7043;"><i class="fas fa-chart-bar"></i> MACD</div>
            <div class="node-body">
                <div class="node-row">
                    <label>Fast</label> <input type="number" df-fast value="12" style="width:40px">
                    <label>Slow</label> <input type="number" df-slow value="26" style="width:40px">
                </div>
                <div class="node-row">
                    <label>Sig</label> <input type="number" df-signal value="9" style="width:40px">
                </div>
                <div class="node-row">
                    <label>MACD</label>
                    <select df-op style="width: 40px">
                        <option value=">">></option>
                        <option value="<"><</option>
                    </select>
                    <label>Sig</label>
                </div>
            </div>
        `;

        const html_bb = `
            <div class="node-header header-indicator" style="background: #AB47BC;"><i class="fas fa-ruler-combined"></i> BB</div>
            <div class="node-body">
                <div class="node-row">
                    <label>Len</label> <input type="number" df-period value="20" style="width:40px">
                    <label>Std</label> <input type="number" df-std value="2" style="width:40px">
                </div>
                <div class="node-row">
                    <label>Close</label>
                    <select df-op style="width: 40px">
                        <option value=">">></option>
                        <option value="<"><</option>
                    </select>
                    <select df-band style="width: 60px">
                        <option value="upper">Upper</option>
                        <option value="lower">Lower</option>
                    </select>
                </div>
            </div>
        `;

        const html_action = `
            <div class="node-header header-action"><i class="fas fa-bolt"></i> Action</div>
            <div class="node-body">
                <select df-action onchange="toggleActionSize(this)">
                    <option value="buy_all">Buy (All Cash)</option>
                    <option value="buy_shares">Buy (Shares)</option>
                    <option value="sell_all">Sell (All Position)</option>
                    <option value="sell_shares">Sell (Shares)</option>
                </select>
                <div class="node-row" df-size-container style="display: none; margin-top: 8px;">
                    <label>Shares</label>
                    <input type="number" df-size value="100" min="1" style="width: 100%;">
                </div>
            </div>
        `;

        // --- Drag & Drop Logic ---

        function allowDrop(ev) {
            ev.preventDefault();
        }

        function drag(ev) {
            ev.dataTransfer.setData("node", ev.target.getAttribute('data-node'));
        }

        function drop(ev) {
            ev.preventDefault();
            const nodeType = ev.dataTransfer.getData("node");
            addNodeToDrawflow(nodeType, ev.clientX, ev.clientY);
        }

        function addNodeToDrawflow(name, pos_x, pos_y) {
            if (editor.editor_mode === 'fixed') {
                return false;
            }

            // Adjust for canvas position
            pos_x = pos_x * (editor.precanvas.clientWidth / (editor.precanvas.clientWidth * editor.zoom)) - (editor.precanvas.getBoundingClientRect().x * (editor.precanvas.clientWidth / (editor.precanvas.clientWidth * editor.zoom)));
            pos_y = pos_y * (editor.precanvas.clientHeight / (editor.precanvas.clientHeight * editor.zoom)) - (editor.precanvas.getBoundingClientRect().y * (editor.precanvas.clientHeight / (editor.precanvas.clientHeight * editor.zoom)));

            switch (name) {
                case 'and':
                    editor.addNode('and', 1, 1, pos_x, pos_y, 'and', {}, html_and);
                    break;
                case 'or':
                    editor.addNode('or', 1, 1, pos_x, pos_y, 'or', {}, html_or);
                    break;
                case 'price':
                    editor.addNode('price', 0, 1, pos_x, pos_y, 'price', { source: 'Close', op: '>', value: 100 }, html_price);
                    break;
                case 'rsi':
                    editor.addNode('rsi', 0, 1, pos_x, pos_y, 'rsi', { period: 14, op: '>', value: 30 }, html_rsi);
                    break;
                case 'sma':
                    editor.addNode('sma', 0, 1, pos_x, pos_y, 'sma', { period: 20, op: '>', value: 100 }, html_sma);
                    break;
                case 'ema':
                    editor.addNode('ema', 0, 1, pos_x, pos_y, 'ema', { period: 20, op: '>', value: 100 }, html_ema);
                    break;
                case 'macd':
                    editor.addNode('macd', 0, 1, pos_x, pos_y, 'macd', { fast: 12, slow: 26, signal: 9, op: '>' }, html_macd);
                    break;
                case 'bb':
                    editor.addNode('bb', 0, 1, pos_x, pos_y, 'bb', { period: 20, std: 2, op: '>', band: 'upper' }, html_bb);
                    break;
                case 'action':
                    editor.addNode('action', 1, 0, pos_x, pos_y, 'action', { action: 'buy_all', size: 100 }, html_action);
                    break;
            }
        }

        // --- Code Generation Logic ---

        // --- Code Generation Logic ---

        function generateCode() {
            const data = editor.export();
            const nodes = data.drawflow.Home.data;
            let initLines = new Set();
            let nextLines = [];

            // Helper to register indicator
            function registerIndicator(node) {
                const id = node.id;
                const d = node.data;
                switch (node.name) {
                    case 'rsi':
                        initLines.add(`self.rsi_${id} = self.I(talib.RSI, self.data.Close, ${d.period})`);
                        return `self.rsi_${id}[-1]`;
                    case 'sma':
                        initLines.add(`self.sma_${id} = self.I(talib.SMA, self.data.Close, ${d.period})`);
                        return `self.sma_${id}[-1]`;
                    case 'ema':
                        initLines.add(`self.ema_${id} = self.I(talib.EMA, self.data.Close, ${d.period})`);
                        return `self.ema_${id}[-1]`;
                    case 'macd':
                        initLines.add(`self.macd_${id}, self.macdsignal_${id}, _ = self.I(talib.MACD, self.data.Close, ${d.fast}, ${d.slow}, ${d.signal})`);
                        return { macd: `self.macd_${id}[-1]`, signal: `self.macdsignal_${id}[-1]` };
                    case 'bb':
                        initLines.add(`self.upper_${id}, self.middle_${id}, self.lower_${id} = self.I(talib.BBANDS, self.data.Close, ${d.period}, ${d.std}, ${d.std})`);
                        return { upper: `self.upper_${id}[-1]`, lower: `self.lower_${id}[-1]`, middle: `self.middle_${id}[-1]` };
                    case 'price':
                        return `self.data.${d.source}[-1]`;
                }
                return null;
            }

            // Recursive condition tracer
            function traceCondition(nodeId, visited = new Set()) {
                if (visited.has(nodeId)) return null; // Cycle detection
                visited.add(nodeId);

                const node = nodes[nodeId];
                if (!node) return null;

                if (node.name === 'and' || node.name === 'or') {
                    const inputs = node.inputs.input_1.connections;
                    if (inputs.length === 0) return null;

                    const conditions = [];
                    for (const conn of inputs) {
                        const cond = traceCondition(conn.node, new Set(visited));
                        if (cond) conditions.push(cond);
                    }

                    if (conditions.length === 0) return null;
                    const joinOp = node.name === 'and' ? ' and ' : ' or ';
                    return `(${conditions.join(joinOp)})`;
                }

                // Indicator nodes (Leaf nodes for logic)
                const val = registerIndicator(node);
                if (!val) return null;

                const d = node.data;
                if (node.name === 'macd') {
                    return `${val.macd} ${d.op} ${val.signal}`;
                } else if (node.name === 'bb') {
                    return `self.data.Close[-1] ${d.op} ${val[d.band]}`;
                } else {
                    // RSI, SMA, EMA, Price
                    return `${val} ${d.op} ${d.value}`;
                }
            }

            // Find Action nodes
            for (const id in nodes) {
                const node = nodes[id];
                if (node.name === 'action') {
                    const inputs = node.inputs.input_1.connections;
                    if (inputs.length > 0) {
                        // Trace back from action
                        const condition = traceCondition(inputs[0].node);
                        if (condition) {
                            const actionType = node.data.action;
                            const size = node.data.size;

                            if (actionType === 'buy_all') {
                                nextLines.push(`if ${condition}:\n            if not self.position:\n                self.buy()`);
                            } else if (actionType === 'buy_shares') {
                                nextLines.push(`if ${condition}:\n            if not self.position:\n                self.buy(size=${size})`);
                            } else if (actionType === 'sell_all') {
                                nextLines.push(`if ${condition}:\n            if self.position:\n                self.position.close()`);
                            } else if (actionType === 'sell_shares') {
                                nextLines.push(`if ${condition}:\n            if self.position:\n                self.sell(size=${size})`);
                            }
                        }
                    }
                }
            }

            if (nextLines.length === 0) {
                document.getElementById('codePreview').textContent = '# Connect nodes to an Action to generate code...';
                return null;
            }

            const fullCode = `from backtesting import Strategy, Backtest
import talib

class FlowStrategy(Strategy):
    def init(self):
        ${Array.from(initLines).join('\n        ') || 'pass'}
    
    def next(self):
        ${nextLines.join('\n        ')}`;

            document.getElementById('codePreview').textContent = fullCode;
            return fullCode;
        }

        // Update code on any change
        editor.on('nodeCreated', generateCode);
        editor.on('nodeRemoved', generateCode);
        editor.on('nodeMoved', generateCode);
        editor.on('connectionCreated', generateCode);
        editor.on('connectionRemoved', generateCode);

        // Helper function to toggle size input visibility
        window.toggleActionSize = function (selectEl) {
            const nodeBody = selectEl.closest('.node-body');
            const sizeContainer = nodeBody.querySelector('[df-size-container]');
            const action = selectEl.value;

            if (action === 'buy_shares' || action === 'sell_shares') {
                sizeContainer.style.display = 'flex';
            } else {
                sizeContainer.style.display = 'none';
            }
        };

        // Listen for input changes in nodes
        document.addEventListener('input', (e) => {
            if (e.target.closest('.drawflow-node')) {
                // Update internal data
                const nodeId = e.target.closest('.drawflow-node').id.replace('node-', '');
                const node = editor.getNodeFromId(nodeId);

                if (e.target.hasAttribute('df-period')) node.data.period = e.target.value;
                if (e.target.hasAttribute('df-value')) node.data.value = e.target.value;
                if (e.target.hasAttribute('df-op')) node.data.op = e.target.value;
                if (e.target.hasAttribute('df-action')) node.data.action = e.target.value;
                if (e.target.hasAttribute('df-size')) node.data.size = e.target.value;
                if (e.target.hasAttribute('df-source')) node.data.source = e.target.value;
                if (e.target.hasAttribute('df-fast')) node.data.fast = e.target.value;
                if (e.target.hasAttribute('df-slow')) node.data.slow = e.target.value;
                if (e.target.hasAttribute('df-signal')) node.data.signal = e.target.value;
                if (e.target.hasAttribute('df-std')) node.data.std = e.target.value;
                if (e.target.hasAttribute('df-band')) node.data.band = e.target.value;

                generateCode();
            }
        });

        // --- Tab Logic ---
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.getAttribute('data-tab');
                switchTab(tabId);
            });
        });

        function switchTab(tabId) {
            // Update buttons
            tabBtns.forEach(btn => {
                if (btn.getAttribute('data-tab') === tabId) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // Update content
            tabContents.forEach(content => {
                if (content.id === `tab-${tabId}`) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });

            // Fix for Drawflow connections disappearing when switching tabs
            if (tabId === 'builder') {
                setTimeout(() => {
                    window.dispatchEvent(new Event('resize'));
                }, 100);
            }
        }

        // --- Sidebar Logic ---
        function toggleSidebar(sidebarId) {
            const sidebar = document.getElementById(sidebarId);
            sidebar.classList.toggle('collapsed');

            // Trigger resize for Drawflow to adjust
            setTimeout(() => {
                window.dispatchEvent(new Event('resize'));
            }, 300);
        }

        // --- VS Code Message Handling ---

        document.getElementById('saveStrategyBtn').addEventListener('click', () => {
            const code = generateCode();
            if (!code) {
                // If no code, maybe alert or just return. 
                // The generateCode function updates the preview text if empty.
                return;
            }

            // Send code to extension to handle saving (native input box)
            vscode.postMessage({
                command: 'requestSaveStrategy',
                code: code
            });
        });

        document.getElementById('runBacktestBtn').addEventListener('click', () => {
            const code = generateCode();
            if (!code) return;

            const config = {
                ticker: document.getElementById('tickerInput').value,
                start: document.getElementById('startDate').value,
                end: document.getElementById('endDate').value,
                strategy_code: code
            };

            // Switch to results tab immediately
            switchTab('results');

            // Show loading state
            const resultsContainer = document.getElementById('resultsContent');
            resultsContainer.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary);">
                    <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px; color: var(--accent-color);"></i>
                    <p>Running Backtest...</p>
                </div>
            `;

            vscode.postMessage({
                command: 'runBacktest',
                config: config
            });
        });

        document.getElementById('deployLiveBtn').addEventListener('click', () => {
            const code = generateCode();
            if (!code) return;

            const config = {
                ticker: document.getElementById('tickerInput').value,
                strategy_code: code,
                strategy_name: 'Visual Strategy',
                mode: 'paper',  // Always paper mode for safety
                position_size: 100
            };

            vscode.postMessage({
                command: 'deployLive',
                config: config
            });
        });

        document.getElementById('clearBtn').addEventListener('click', () => {
            editor.clearModuleSelected();
        });

        document.getElementById('exampleBtn').addEventListener('click', () => {
            // Complex Strategy Example
            editor.clearModuleSelected();

            // Add nodes centered in the view
            // We assume a standard viewport and place nodes to be visible
            const rsi = editor.addNode('rsi', 0, 1, 100, 150, 'rsi', { period: 14, op: '>', value: 30 }, html_rsi);
            const sma = editor.addNode('sma', 0, 1, 100, 350, 'sma', { period: 20, op: '>', value: 100 }, html_sma);
            const and = editor.addNode('and', 1, 1, 400, 250, 'and', {}, html_and);
            const action = editor.addNode('action', 1, 0, 700, 250, 'action', { action: 'buy_all', size: 100 }, html_action);

            // Connect nodes
            editor.addConnection(rsi, and, 'output_1', 'input_1');
            editor.addConnection(sma, and, 'output_1', 'input_1');
            editor.addConnection(and, action, 'output_1', 'input_1');
        });

        document.getElementById('pullFromChartBtn').addEventListener('click', () => {
            vscode.postMessage({
                command: 'requestChartState'
            });
        });

        window.addEventListener('message', event => {
            const message = event.data;
            switch (message.type) {
                case 'backtestResults':
                    displayResults(message.results);
                    break;
                case 'backtestError':
                    displayResults({ error: message.error });
                    break;
                case 'chartState':
                    if (message.ticker) document.getElementById('tickerInput').value = message.ticker;
                    if (message.start) document.getElementById('startDate').value = new Date(message.start * 1000).toISOString().split('T')[0];
                    if (message.end) document.getElementById('endDate').value = new Date(message.end * 1000).toISOString().split('T')[0];
                    break;
                case 'deploymentOutput':
                    const terminal = document.getElementById('deployTerminal');
                    if (terminal) {
                        terminal.innerHTML += message.output;
                        terminal.scrollTop = terminal.scrollHeight;  // Auto-scroll to bottom
                    }
                    break;
                case 'clearDeploymentOutput':
                    const term = document.getElementById('deployTerminal');
                    if (term) term.innerHTML = '';
                    break;
            }
        });

        function displayResults(results) {
            const container = document.getElementById('resultsContent');
            if (results.error) {
                container.innerHTML = `<div style="color: var(--danger-color); padding: 20px;">Error: ${results.error}</div>`;
                return;
            }

            // Format metrics
            // Keys match backtest_runner.py output: return, sharpe, max_drawdown, win_rate, num_trades
            const metrics = [
                { label: 'Return', value: results.return, format: v => `${parseFloat(v).toFixed(2)}%` },
                { label: 'Sharpe Ratio', value: results.sharpe, format: v => parseFloat(v).toFixed(2) },
                { label: 'Max Drawdown', value: results.max_drawdown, format: v => `${parseFloat(v).toFixed(2)}%` },
                { label: 'Win Rate', value: results.win_rate, format: v => `${parseFloat(v).toFixed(2)}%` },
                { label: 'Trades', value: results.num_trades, format: v => v }
            ];

            let html = '<div class="results-grid">';
            metrics.forEach(m => {
                const val = m.value;
                const formatted = m.format(val);
                let colorClass = '';
                if (m.label === 'Return' || m.label === 'Sharpe Ratio') {
                    colorClass = parseFloat(val) > 0 ? 'positive' : 'negative';
                }

                html += `
                    <div class="metric-card">
                        <div class="metric-label">${m.label}</div>
                        <div class="metric-value ${colorClass}">${formatted}</div>
                    </div>
                `;
            });
            html += '</div>';

            // Removed raw JSON dump as per user request

            container.innerHTML = html;
        }

        // Init
        setTimeout(() => {
            if (document.getElementById('exampleBtn')) {
                document.getElementById('exampleBtn').click();
            }
        }, 100);

    </script>
</body>

</html>