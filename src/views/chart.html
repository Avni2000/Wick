<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="Content-Security-Policy" content="
      default-src 'none';
      script-src https://unpkg.com 'unsafe-inline';
      style-src 'unsafe-inline';
      img-src 'self' data:;
      connect-src https:;
    " />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Candles - {{ticker}}</title>
    <style>
        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            background: #1e1e1e;
            color: #ccc;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Ubuntu, Cantarell, sans-serif;
        }

        #chart {
            width: 100%;
            height: 100vh;
        }

        .ticker-header {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
            background: rgba(30, 30, 30, .9);
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid #3e3e42;
            min-width: 250px;
        }

        .ticker-input-container {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            align-items: center;
        }

        .ticker-input {
            flex: 1;
            background: rgba(60, 60, 60, 0.8);
            border: 1px solid #3e3e42;
            color: #fff;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        .ticker-input:focus {
            outline: none;
            border-color: #007acc;
        }

        .search-btn {
            background: #007acc;
            border: none;
            color: #fff;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .search-btn:hover {
            background: #005a9e;
        }

        .ticker-name {
            font-size: 18px;
            font-weight: 700;
            color: #fff;
        }

        .ticker-price {
            font-size: 14px;
            margin-top: 4px;
        }

        .range-selector {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            display: flex;
            gap: 8px;
            background: rgba(30, 30, 30, .9);
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #3e3e42;
        }

        .range-btn {
            background: transparent;
            color: #ccc;
            border: 1px solid #3e3e42;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .range-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #666;
        }

        .range-btn.active {
            background: #007acc;
            border-color: #007acc;
            color: #fff;
        }
    </style>
</head>

<body>
    <div class="ticker-header">
        <div class="ticker-input-container">
            <input type="text" class="ticker-input" id="tickerInput" placeholder="Enter ticker symbol..." />
            <button class="search-btn" id="searchBtn">Search</button>
        </div>
        <div class="ticker-name" id="ticker"></div>
        <div class="ticker-price" id="price">Loadingâ€¦</div>
    </div>
    <div id="chart"></div>
    <div class="range-selector">
        <button class="range-btn" data-range="1d">1D</button>
        <button class="range-btn" data-range="1w">1W</button>
        <button class="range-btn" data-range="1mo">1M</button>
        <button class="range-btn" data-range="3mo">3M</button>
        <button class="range-btn" data-range="1y">1Y</button>
        <button class="range-btn active" data-range="5y">5Y</button>
        <button class="range-btn" data-range="max">MAX</button>
    </div>

    <script>
        const TICKER = {{ ticker }};
        const DEFAULT_RANGE = '5y'; // auto 5-year view
    </script>

    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <script>
        (function () {
            const vscode = acquireVsCodeApi();
            const LWC = window.LightweightCharts;
            const container = document.getElementById('chart');
            const priceEl = document.getElementById('price');
            const tickerEl = document.getElementById('ticker');
            const tickerInput = document.getElementById('tickerInput');
            const searchBtn = document.getElementById('searchBtn');

            // Current ticker state
            let currentTicker = TICKER;

            const chart = LWC.createChart(container, {
                width: container.clientWidth,
                height: container.clientHeight,
                layout: { background: { color: '#1e1e1e' }, textColor: '#d1d4dc' },
                grid: { vertLines: { color: '#2b2b43' }, horzLines: { color: '#2b2b43' } },
                timeScale: { borderColor: '#485c7b' },
                rightPriceScale: { borderColor: '#485c7b' },
            });

            // Keep chart perfectly responsive
            new ResizeObserver(entries => {
                const cr = entries[0].contentRect;
                chart.applyOptions({ width: cr.width, height: cr.height });
            }).observe(container);

            // v5 API: use addSeries with CandlestickSeries
            const candles = chart.addSeries(LWC.CandlestickSeries, {
                upColor: '#26a69a',
                downColor: '#ef5350',
                wickUpColor: '#26a69a',
                wickDownColor: '#ef5350',
                borderVisible: false,
            });

            tickerEl.textContent = TICKER.toUpperCase();
            tickerInput.value = TICKER.toUpperCase();
            priceEl.textContent = 'Fetching data...';

            // Store current range
            let currentRange = DEFAULT_RANGE;

            // Function to fetch data for a specific ticker and range
            function fetchData(ticker, range) {
                currentTicker = ticker;
                currentRange = range;
                priceEl.textContent = 'Loading...';
                tickerEl.textContent = ticker.toUpperCase();

                // Determine appropriate interval based on range
                let interval = '1d';
                if (range === '1d') interval = '5m';
                else if (range === '1w') interval = '30m';
                else if (range === '1mo' || range === '3mo') interval = '1d';
                else interval = '1d';

                vscode.postMessage({
                    command: 'fetchStockData',
                    ticker: ticker,
                    range: range,
                    interval: interval
                });
            }

            // Function to fetch data for a specific range (keeping current ticker)
            function fetchRange(range) {
                fetchData(currentTicker, range);
            }

            // Handle ticker search
            function searchTicker() {
                const newTicker = tickerInput.value.trim().toUpperCase();
                if (newTicker && newTicker !== currentTicker) {
                    fetchData(newTicker, currentRange);
                }
            }

            searchBtn.addEventListener('click', searchTicker);
            tickerInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchTicker();
                }
            });

            // Setup range selector buttons
            const rangeButtons = document.querySelectorAll('.range-btn');
            rangeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Update active state
                    rangeButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    // Fetch new data
                    const range = btn.getAttribute('data-range');
                    fetchRange(range);
                });
            });

            // Request initial data from extension backend
            fetchRange(DEFAULT_RANGE);

            // Handle messages from extension
            window.addEventListener('message', event => {
                const message = event.data;

                switch (message.type) {
                    case 'candles':
                        const data = message.candles;
                        console.log(`Received ${data.length} candles for range: ${message.range || currentRange}`);

                        if (!data || !data.length) {
                            priceEl.textContent = 'No data available';
                            priceEl.style.color = '#ef5350';
                            return;
                        }

                        // Update chart data
                        candles.setData(data);
                        chart.timeScale().fitContent();

                        // Update price display
                        const last = data[data.length - 1];
                        const prev = data[data.length - 2] ?? last;
                        const pct = prev.close ? (((last.close - prev.close) / prev.close) * 100).toFixed(2) : '0.00';
                        priceEl.textContent = `$${last.close.toFixed(2)} (${(last.close - prev.close >= 0 ? '+' : '') + pct}%)`;
                        priceEl.style.color = (last.close - prev.close) >= 0 ? '#26a69a' : '#ef5350';
                        console.log('Chart loaded successfully!');
                        break;

                    case 'error':
                        console.error('Error from extension:', message.message);
                        priceEl.textContent = 'Error: ' + message.message;
                        priceEl.style.color = '#ef5350';
                        break;

                    case 'requestChartState':
                        const visibleRange = chart.timeScale().getVisibleRange();
                        vscode.postMessage({
                            command: 'chartState',
                            ticker: currentTicker,
                            start: visibleRange ? visibleRange.from : null,
                            end: visibleRange ? visibleRange.to : null
                        });
                        break;
                }
            });
        })();
    </script>
</body>

</html>