<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="Content-Security-Policy" content="
      default-src 'none';
      script-src https://unpkg.com 'unsafe-inline';
      style-src 'unsafe-inline';
      img-src 'self' data:;
      connect-src https:;
    " />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Candles - {{ticker}}</title>
    <style>
        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            background: #1e1e1e;
            color: #ccc;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Ubuntu, Cantarell, sans-serif;
        }

        #chart {
            width: 100%;
            height: 100vh;
        }

        .ticker-header {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
            background: rgba(30, 30, 30, .9);
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid #3e3e42;
        }

        .ticker-name {
            font-size: 18px;
            font-weight: 700;
            color: #fff;
        }

        .ticker-price {
            font-size: 14px;
            margin-top: 4px;
        }
    </style>
</head>

<body>
    <div class="ticker-header">
        <div class="ticker-name" id="ticker"></div>
        <div class="ticker-price" id="price">Loadingâ€¦</div>
    </div>
    <div id="chart"></div>

    <script>
        const TICKER = {{ ticker }};
        const DEFAULT_RANGE = '5y'; // auto 5-year view
    </script>

    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <script>
        (function () {
            const vscode = acquireVsCodeApi();
            const LWC = window.LightweightCharts;
            const container = document.getElementById('chart');
            const priceEl = document.getElementById('price');
            const tickerEl = document.getElementById('ticker');

            const chart = LWC.createChart(container, {
                width: container.clientWidth,
                height: container.clientHeight,
                layout: { background: { color: '#1e1e1e' }, textColor: '#d1d4dc' },
                grid: { vertLines: { color: '#2b2b43' }, horzLines: { color: '#2b2b43' } },
                timeScale: { borderColor: '#485c7b' },
                rightPriceScale: { borderColor: '#485c7b' },
            });

            // Keep chart perfectly responsive
            new ResizeObserver(entries => {
                const cr = entries[0].contentRect;
                chart.applyOptions({ width: cr.width, height: cr.height });
            }).observe(container);

            // v5 API: use addSeries with CandlestickSeries
            const candles = chart.addSeries(LWC.CandlestickSeries, {
                upColor: '#26a69a',
                downColor: '#ef5350',
                wickUpColor: '#26a69a',
                wickDownColor: '#ef5350',
                borderVisible: false,
            });

            tickerEl.textContent = TICKER.toUpperCase();
            priceEl.textContent = 'Fetching data...';

            // Request data from extension backend
            vscode.postMessage({
                command: 'fetchStockData',
                ticker: TICKER
            });

            // Handle messages from extension
            window.addEventListener('message', event => {
                const message = event.data;

                switch (message.type) {
                    case 'candles':
                        const data = message.candles;
                        console.log('Received candles:', data.length);

                        if (!data || !data.length) {
                            priceEl.textContent = 'No data available';
                            priceEl.style.color = '#ef5350';
                            return;
                        }

                        candles.setData(data);
                        chart.timeScale().fitContent();

                        // Update price display
                        const last = data[data.length - 1];
                        const prev = data[data.length - 2] ?? last;
                        const pct = prev.close ? (((last.close - prev.close) / prev.close) * 100).toFixed(2) : '0.00';
                        priceEl.textContent = `$${last.close.toFixed(2)} (${(last.close - prev.close >= 0 ? '+' : '') + pct}%)`;
                        priceEl.style.color = (last.close - prev.close) >= 0 ? '#26a69a' : '#ef5350';
                        console.log('Chart loaded successfully!');
                        break;

                    case 'error':
                        console.error('Error from extension:', message.message);
                        priceEl.textContent = 'Error: ' + message.message;
                        priceEl.style.color = '#ef5350';
                        break;
                }
            });
        })();
    </script>
</body>

</html>